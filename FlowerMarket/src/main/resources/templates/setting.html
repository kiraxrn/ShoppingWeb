<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>账户设置</title>
    <link rel="stylesheet" href="/static/css/setting.css">
</head>
<body>
<div class="container">
    <!-- 头像上传 -->
    <div class="form-section">
        <h2>个人头像</h2>
        <div class="avatar-upload">
            <img th:src="${response.userpicture ?: '/static/img/Avatar.png'}"
                 alt="Profile Picture"
                 class="avatar-preview"
                 id="avatarPreview">
            <div>
                <input type="file" id="avatarInput" accept="image/*">
                <button onclick="uploadAvatar()">上传头像</button>
            </div>
        </div>
    </div>

    <!-- 基本信息 -->
    <div class="form-section">
        <h2>基本信息</h2>
        <form id="basicForm">
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="username"
                       th:value="${response.username}" required>
            </div>
            <div class="form-group">
                <label>电子邮箱</label>
                <input type="email" id="email"
                       th:value="${response.email}" required>
            </div>
            <button type="submit">保存修改</button>
        </form>
    </div>

    <!-- 密码修改 -->
    <div class="form-section">
        <h2>修改密码</h2>
        <form id="passwordForm">
            <div class="form-group">
                <label>旧密码</label>
                <input type="password" id="oldPassword" required>
            </div>
            <div class="form-group">
                <label>新密码</label>
                <input type="password" id="newPassword" required>
            </div>
            <button type="submit">修改密码</button>
        </form>
    </div>
</div>

<script>
    // 头像上传
    async function uploadAvatar() {
        const fileInput = document.getElementById('avatarInput');
        if (!fileInput.files[0]) {
            alert('请选择要上传的文件');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', fileInput.files[0]);

        try {
            const response = await fetch('/user/avatar', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                document.getElementById('avatarPreview').src = result.avatarUrl;
                alert('头像更新成功');
            } else {
                alert(result.message || '头像上传失败');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('网络请求失败');
        }
    }

    // 基本信息提交
    document.getElementById('basicForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const updates = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
        };

        try {
            const response = await fetch('/user/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });

            const result = await response.json();
            if (result.success) {
                alert('信息更新成功');
                window.location.reload(); // 刷新页面获取最新数据
            } else {
                alert(result.message || '更新失败');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('网络请求失败');
        }
    });

    // 修改密码
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const passwords = {
            oldPassword: document.getElementById('oldPassword').value,
            newPassword: document.getElementById('newPassword').value
        };

        try {
            const response = await fetch('/user/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(passwords)
            });

            const result = await response.json();
            alert(result.message);
            if (result.success) {
                document.getElementById('passwordForm').reset();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('网络请求失败');
        }
    });
</script>
</body>
</html>